# 1.梯度计算方法

训练变分量子算法（VQA）高度依赖于经典优化循环。如我们所论，VQA包含一个参数化量子电路（PQC） $U(\theta)$ 和一个成本函数 $C(\theta)$ ，该函数通常定义为在PQC准备的输出态上测量的可观测量 $H$ 的期望值：

```math
C(\theta)=\langle\psi(\theta)|H|\psi(\theta)\rangle=\langle 0|U^{\dagger}(\theta)HU(\theta)|0\rangle
```

这里的 $|0\rangle$ 是指PQC的输入态，不限于 $|0\rangle$ 。

为了使用基于梯度的办法（例如梯度下降及其变体）最小化此成本函数，我们需要计算梯度向量 $\nabla_{\theta}C(\theta)$ ，其分量为相对于电路中的每个参数 $\theta_{j}$ 的偏导数 $\frac{\partial C}{\partial \theta_{j}}$ 。由于成本函数评估涉及运行量子电路和执行测量，因此计算这些梯度需要专门为这种混合量子-经典配置设计的技术。我们来分析实践中使用的主要办法。

## 1.1 数值有限差分

最直接的办法直接借鉴于经典数值办法：有限差分。为了估算相对于参数 $\theta_{j}$ 的偏导数，我们可以在轻微扰动的参数值处评估成本函数。中心差分公式常用：

```math
\frac{\partial C}{\partial \theta_{j}} \approx \frac{C(\theta+\epsilon e_{j})-C(\theta-\epsilon e_{j})}{2\epsilon}
```

这里， $e_{j}$ 是一个在第j个位置为1、其余位置为0的单位向量， $\epsilon$ 是一个小步长。此办法需要对量子电路进行两次评估（并估算期望值），以计算每个参数 $\theta_{j}$ 的偏导数。

尽管有限差分易于理解和实现，但在量子计算背景下，它存在显著缺点：

1. $\epsilon$ 的选择：选择合适的 $\epsilon$ 比较困难。如果 $\epsilon$ 过大，近似就不准确（截断误差）。如果 $\epsilon$ 过小， $C(\theta+\epsilon e_{j})-C(\theta-\epsilon e_{j})$ 的差值可能被统计噪声（散粒噪声）所主导，这种噪声源于从有限次测量中估算期望值，导致梯度估算中出现较大误差（减法误差）。

2. 统计噪声：分子中的减法会放大散粒噪声的影响，尤其当 $C(\theta+\epsilon e_{j})$ 和 $C(\theta-\epsilon e_{j})$ 非常接近时。为了达到足够的精度，每次评估通常需要大量的测量（shots），从而增加了计算成本。

由于这些局限，尽管有限差分对于快速检查或简单问题有益，但对于训练VQA，通常倾向于使用更专门的办法。

## 1.2 参数位移规则

一种更广为采用的计算 PQC 梯度的办法是参数位移规则。对于特定类别的参数化门，该规则提供了梯度的解析表达式，避免了与在有限差分中选择  $\epsilon$ 相关的数值不稳定性。

考虑 PQC 中形式为 $G_{j}(\theta_{j})=e^{-i\frac{\theta_{j}}{2}P_{j}}$ 的一个门，其中 $P_{j}$ 是一个满足 $P_{j}^{2}=I$ 的算符。这包含常见的单比特旋转门，例如 $R_{X}(\theta_{j})=e^{-i\frac{\theta_{j}}{2}X}$ 、 $R_{Y}(\theta_{j})=e^{-i\frac{\theta_{j}}{2}Y}$ 和 $R_{Z}(\theta_{j})=e^{-i\frac{\theta_{j}}{2}Z}$ ，因为 $X^{2}=Y^{2}=Z^{2}=I$ 。

如果整个 PQC $U(\theta)$ 可以写为 $U(\theta)=VG_{j}(\theta_{j})W$ ，其中 V 和 W 是与 $\theta_{j}$ 无关的其他量子电路，那么期望值 $C(\theta)=\langle 0|U^{\dagger}(\theta)HU(\theta)|0\rangle$ 相对于 $\theta_{j}$ 的导数可以使用以下公式精确计算：
```math
\frac{\partial C(\theta)}{\partial \theta_{j}}=\frac{1}{2}\left[C\left(\theta+\frac{\pi}{2} e_{j}\right)-C\left(\theta-\frac{\pi}{2} e_{j}\right)\right]
```
这个显著的结论表明，精确导数与在参数 $\theta_{j}$ 向前和向后位移特定量 $s=\pi/2$ 后评估的成本函数差值成比例。

其原理何在？我们概述一下思路。求导涉及对门 $G_{j}(\theta_{j})$ 进行求导： $\frac{\partial G_{j}(\theta_{j})}{\partial \theta_{j}}=-\frac{i}{2} P_{j} e^{-i\frac{\theta_{j}}{2} P_{j}}=-\frac{i}{2} P_{j} G_{j}(\theta_{j})$ 。将其代入 $C(\theta)$ 的导数表达式会导致包含 $P_{j}$ 的项。主要的认识是，对于 $P_{j}^{2}=I$ 的门，算符 $P_{j}$ 可以与原始门 $G_{j}(\theta_{j})$ 的位移版本相关联。具体而言，可以证明：
```math
P_{j} G_{j}(\theta_{j})=\frac{i}{2}\left[G_{j}\left(\theta_{j}+\frac{\pi}{2}\right)-G_{j}\left(\theta_{j}-\frac{\pi}{2}\right)\right]
```
将其代回 $C(\theta)$ 的导数表达式并简化，最终得到参数位移规则公式。

<div align="center">

![Image](https://github.com/user-attachments/assets/6d47b99e-c9c7-4d79-830b-4ea287ac18a7)

*参数位移规则*
</div>

### 优点、成本与适用性

**优点：**
* **解析精确：** 它提供了真实梯度，而非数值近似（在评估 $C$ 时会受到散粒噪声影响）。
* **无需调整步长：** 它避免了选择小 $\epsilon$ 的问题。位移量 $s=\pi/2$ 是固定的。
* **韧性：** 相较于有限差分，它对散粒噪声通常更具韧性，因为位移量较大，使得差值 $C(\theta+se_{j})-C(\theta-se_{j})$ 相对于噪声基底通常更大。

**成本：**
与中心有限差分类似，参数位移规则对每个参数 $\theta_{j}$ 需要两次电路评估。

**适用性：**
基本规则直接适用于由泡利算符（X, Y, Z）生成的门。QML 中常用的大多数 PQC 拟设主要是由这类门构建的，使参数位移规则得以广泛应用。


# 2.经典优化方法
# 3.量子自然梯度下降
# 4.荒原高原